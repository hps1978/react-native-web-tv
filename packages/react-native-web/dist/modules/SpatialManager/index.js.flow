/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * @flow strict
 * @format
 */

// This module supports SpatialNavigation for TV platforms on web using
// the @bbc/tv-lrud-spatial library. Currently, SpatialNavigation working
// completely outside the React tree, i.e, it uses DOM APIs to manage
// focus and navigation.

// Currently, it only supports arrow ISO keyboard navigation.
import { setConfig, getNextFocus, getFocusableParentContainer, getParentContainer, updateAncestorsAutoFocus, findDestinationOrAutofocus } from '@bbc/tv-lrud-spatial';
import { startObserving, stopObserving, type MutationDetails } from './mutationObserver';
import { DEFAULT_SPATIAL_SCROLL_CONFIG, type SpatialScrollConfig, type ReAcquireFocusOptions, createScrollState, maybeScrollOnFocus, setupAppInitiatedScrollHandler } from './scrollHandler';
import { addEventListener } from '../addEventListener';
import { setupNodeId } from '../../exports/TV/utils';
type SpatialNavigationConfig = {
  keyMap?: {
    [key: string]: string
  },
  scrollConfig?: SpatialScrollConfig,
  keydownThrottleMs?: number,
  focusMode?: 'LeftTop' | 'default',
};
type FocusState = {
  elem: HTMLElement | null,
  parentHasAutofocus: boolean,
};
let isSpatialManagerReady = false;
let spatialNavigationContainer: HTMLElement | null = null;
let currentFocus: FocusState = {
  elem: null,
  parentHasAutofocus: false
};
let pendingFocus: FocusState | null = null;
let navigationSequence = 0;
let keydownThrottleMs = 0;
let focusMode: 'LeftTop' | 'default' = 'default';
let keyDownListener: ((event: any) => void) | null = null;
let keyUpListener: ((event: any) => void) | null = null;
let appInitiatedScrollCleanup: (() => void) | null = null;
let spatialScrollConfig: SpatialScrollConfig = {
  ...DEFAULT_SPATIAL_SCROLL_CONFIG
};
let lastKeydownAt = 0;
const scrollState = createScrollState();
const DEBUG_SCROLL = typeof window !== 'undefined' && window.__RNW_TV_SCROLL_DEBUG === true;
const hasAnimationFrame = typeof window !== 'undefined' && typeof window.requestAnimationFrame === 'function';
declare function loadGlobalConfig(): SpatialNavigationConfig | null; // This callback wil get triggered when LRUD fails to find a valid destination from the provided data-destinations
// atrtribute. LRUD will use it's fallback. autofocus or default focus logic. This contianer will no longer be
// focusable if there is no autofocus either.
declare function noValidDestinationCallback(candidateContainer: any, hasAutoFocus: any): any; // Setup configuration for Spatial Navigation
// User provided through global configs or defaults
declare function setSpatialNavigationConfig(): any;
declare function handleCurrentFocusMutations(details: MutationDetails): void;
declare function triggerFocus(nextFocus: FocusState, keyCode?: string, options?: {
  sequence?: number,
  navigationFrom?: HTMLElement | null,
  focusMode?: 'LeftTop' | 'default',
}): boolean;
declare function handlePageVisibilityChange(event: any): any;
declare function setupPageVisibilityListeners(): any;
declare function setupAppInitiatedScrollTracking(): any;
declare function setupSpatialNavigation(container?: HTMLElement): any;
declare function setFocus(node: HTMLElement): any; // WARNING: This is a very specific API to set destinations for TVFocusGuideView and is not meant for general use.
// It may have unexpected results if used outside of the context of TVFocusGuideView.
declare function setDestinations(host: HTMLElement, destinations: HTMLElement[]): any;
declare function teardownSpatialNavigation(): any;
export { setupSpatialNavigation, setFocus, teardownSpatialNavigation, setDestinations };